# Custom NGPC Driver (latest copy)

This folder is the canonical location for the most up-to-date custom driver.
Always update these files when the driver changes.

**Files**
- `sounds.c`
- `sounds.h`
- `sounds_game_sfx_template.c` (optional template for game-specific SFX mapping)

**Capabilities (Exhaustive)**
- Embedded Z80 polling driver (`s_z80drv[]`) in Z80 RAM 0x0000.., shared RAM window 0x7000.. (CPU side).
- Multi-command PSG buffer (up to 5 PSG commands per frame).
- Non-blocking buffer policy with drop counter and fault flag.
- Dual-port PSG writes for mono (0x4000 + 0x4001).
- Tone channels (3) + noise channel (1) with per-channel base regs.
- SFX playback on 4 channels with per-channel timers.
- SFX tone sweep (linear up/down), optional ping-pong sweep.
- SFX vibrato (depth, speed, delay).
- SFX envelope (step + speed) for tone and noise.
- SFX noise burst mode (duration override).
- BGM playback on up to 4 voices (3 tone + 1 noise).
- Frame-locked BGM scheduling (VBlank-based) to avoid tempo drift.
- BGM loop support via loop offsets per stream.
- BGM speed multiplier (global tempo scaling).
- BGM gate (percent) to shorten notes (`Bgm_SetGate`).
- BGM per-voice instrument preset (BGM_OP_SET_INST).
- BGM per-voice envelopes, vibrato, sweep (stream opcodes).
- BGM per-voice macro steps (optional instrument macro table).
- Optional envelope curves (per-instrument LUT).
- Optional pitch curves (per-instrument LUT).
- Instrument presets can select `macro_id` and `env_curve_id` (see `sounds.c`).
- Instrument presets can select `pitch_curve_id` (see `sounds.c`).
- Optional compile flags (default on): `SOUNDS_ENABLE_MACROS`, `SOUNDS_ENABLE_ENV_CURVES`,
  `SOUNDS_ENABLE_PITCH_CURVES`.
- Default pitch curves (IDs):
  - 0 = none
  - 1 = gentle down
  - 2 = gentle up
  - 3 = wobble
  - 4 = fast fall
- Example data is optional (default on): `SOUNDS_ENABLE_EXAMPLE_PRESETS`.
- Instrument presets use `BGM_INST(...)` for readability (see `sounds.c`).
- Default instrument IDs (from `sounds.c`): 0 clean, 1 noise, 2 lead, 3 pad, 4 pluck,
  5 bass, 6 bell, 7 zap.
- Automatic BGM channel restore after SFX ends (restore flags).
- PSG reset bases on init/reset (hardware stability).
- Latch-only silence writes to avoid partial data-byte effects.
- PSG shadow caching to skip redundant writes (reduces IO churn).
- Debug counters and snapshot hooks (BGM_DEBUG).

**Public API (sounds.h)**
- `Sounds_Init`, `Sounds_ResetState`, `Sounds_Update`.
- `Sounds_DebugFault`, `Sounds_DebugDrops`, `Sounds_DebugLastSfx`.
- `Sfx_Update`, `Sfx_Play`, `Sfx_PlayToneCh`, `Sfx_PlayToneEx`, `Sfx_PlayNoise`, `Sfx_PlayNoiseEx`.
- `Sfx_SendBytes`, `Sfx_BufferBegin`, `Sfx_BufferPush`, `Sfx_BufferCommit`, `Sfx_Stop`.
- `Bgm_Start`, `Bgm_StartEx`, `Bgm_StartLoop`, `Bgm_StartLoop2`, `Bgm_StartLoop2Ex`, `Bgm_StartLoop3`, `Bgm_StartLoop3Ex`, `Bgm_StartLoop4`, `Bgm_StartLoop4Ex`, `Bgm_Stop`.
- `Bgm_Update`, `Bgm_SetSpeed`, `Bgm_SetGate`.
- `Bgm_DebugReset`, `Bgm_DebugSnapshot`.

**BGM Stream Format (current)**
- Stream is a sequence of bytes; events are parsed at runtime.
- Note event: `note` (1..NOTE_MAX_INDEX+1) then `duration` (frames scaled by speed).
- End marker: `0x00` (stop, or loop if loop enabled).
- Rest: `0xFF` then `duration` (silence for duration).
- `BGM_OP_SET_ATTN (0xF0)`: next byte = attenuation (0..15).
- `BGM_OP_SET_ENV (0xF1)`: next bytes = env_step, env_speed.
- `BGM_OP_SET_VIB (0xF2)`: next bytes = depth, speed, delay.
- `BGM_OP_SET_SWEEP (0xF3)`: next bytes = end_lo, end_hi, step (s8), speed.
- `BGM_OP_SET_INST (0xF4)`: next byte = instrument id.
- Example (single voice): `note, dur, note, dur, 0xF0, attn, 0x00`.
- NOTE_TABLE and stream arrays are provided by your build (e.g. generated by `midi_to_ngpc`).

**SFX Behavior (current)**
- SFX uses frame timers per channel (0..3).
- Tone SFX supports sweep, envelope, vibrato.
- Noise SFX supports envelope and burst.
- Burst mode alternates on/off pulses for a gated noise effect.
- When SFX ends, channel is silenced and BGM restore is triggered.
- `Sfx_Play` is a no-op in the clean driver; use `Sfx_PlayPresetTable` or define `SFX_PLAY_EXTERNAL` and provide your own mapping.
- Data-driven presets are supported via `SfxPreset`/`Sfx_PlayPresetTable` (see comment in `sounds.h`).
- Template: `sounds_game_sfx_template.c` shows how to keep game-specific SFX mappings out of the driver.

**Known Limits**
- Buffer max is 5 PSG commands per frame.
- Noise channel is monophonic and shares the noise register.
- Stream uses NOTE_TABLE for divider lookup (NOTE_MAX_INDEX = 50).
- This is a polling Z80 driver (no NMI/COMM protocol).
- Tone voices cannot switch into noise mode (only noise channel uses noise mode).
- Optional: `SOUNDS_MAX_CATCHUP` can clamp long frame catch-up loops.

**Inspiration**
- `vgmlib-ngpc` (winteriscomingpinball)
